    def rechercher_manga_par_titre(self, titre):
        """Recherche et renvoie un manga par son titre

        Parameters
        ---------
        titre: str
            titre du manga qu'on veut rechercher

        Returns
        -------
        manga: Manga
            renvoie le manga
        """
        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "Select titre",
                        "From manga",
                        "Where titre LIKE '%(titre)%' ",
                        {"titre": titre},
                    )
                    res = cursor.fetchone
        except Exception as e:
            logging.info(e)
            raise
        liste_manga = []
        if res:
            liste_manga = [res[titre]]
        return liste_manga

import json
import logging
from utils.log_decorator import log
from utils.singleton import Singleton
from dao.db_connection import DBConnection
from business_object.manga import Manga


class MangaDao(metaclass=Singleton):
    """classe MangaDao"""

    def trouver_manga_par_id(self, id_manga) -> Manga:
        """Recherche et renvoie un manga par son id

        Parameters
        ---------
        id_manga: int
            numéro du manga qu'on veut rechercher

        Returns
        -------
        manga: Manga
            renvoie le manga
        """
        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "Select *",
                        "From manga",
                        "Where id_manga = %(id_manga)s ",
                        {"id_manga": id_manga},
                    )
                    res = cursor.fetchone()
        except Exception as e:
            logging.info(e)
            raise
        manga = None
        if res:
            manga = Manga(
                id_manga=res["id_manga"],
                titre=res["titre"],
                synopsis=res["synopsis"],
                auteurs=res["auteurs"],
                themes=res["themes"],
                genre=res["genre"],
            )
        return manga

    def trouver_manga_par_titre(self, titre):
        """Recherche et renvoie un manga par son titre

        Parameters
        ---------
        titre: str
            titre du manga qu'on veut rechercher

        Returns
        -------
        manga: Manga
            renvoie le manga
        """
        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "Select *",
                        "From manga",
                        "Where titre = %(titre)s ",
                        {"titre": titre},
                    )
                    res = cursor.fetchone
        except Exception as e:
            logging.info(e)
            raise
        manga = None
        if res:
            manga = Manga(
                id_manga=res["id_manga"],
                titre=res["titre"],
                synopsis=res["synopsis"],
                auteurs=res["auteurs"],
                themes=res["themes"],
                genre=res["genre"],
            )
        return manga

    @log
    def inserer_mangas(self, fichier):
        """Insère les mangas, les auteurs, les genres et les themes dans la base de données"""
        with open(fichier, "r", encoding="utf-8") as f:
            mangas_data = json.load(f)
        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    # Réinitialiser les IDs
                    cursor.execute("TRUNCATE TABLE manga RESTART IDENTITY CASCADE;")
                    cursor.execute("TRUNCATE TABLE theme RESTART IDENTITY CASCADE;")
                    cursor.execute("TRUNCATE TABLE auteur RESTART IDENTITY CASCADE;")
                    cursor.execute("TRUNCATE TABLE genre RESTART IDENTITY CASCADE;")

                    # Dictionnaires pour vérfier les doublons des noms des thèmes/auteurs/genres
                    theme_id_map = {}
                    author_id_map = {}
                    genre_id_map = {}

                    # Insertion des mangas
                    for manga in mangas_data:
                        titre = manga[0]
                        volumes = manga[1]
                        publication = manga[3]["string"]
                        synopsis = manga[4]
                        cursor.execute(
                            "INSERT INTO manga(titre, volumes, publication, synopsis)"
                            "VALUES (%(titre)s, %(volumes)s, %(publication)s, %(synopsis)s)"
                            "RETURNING id_manga;",
                            {
                                "titre": titre,
                                "volumes": volumes,
                                "publication": publication,
                                "synopsis": synopsis,
                            },
                        )
                        manga_id = cursor.fetchone()["id_manga"]  # Récupérer l'id du manga inséré

                        # Gestion des auteurs
                        for author in manga[5]:
                            if author not in author_id_map:
                                cursor.execute(
                                    """
                                    INSERT INTO auteur (name_auteur)
                                    VALUES (%s)
                                    RETURNING id_auteur;
                                    """,
                                    (author,),
                                )
                                res = cursor.fetchone()["id_auteur"]
                                if res:
                                    author_id_map[author] = res

                            cursor.execute(
                                """
                                INSERT INTO association_manga_auteur(id_manga, id_auteur)
                                VALUES (%(id_manga)s, %(id_auteur)s);
                                """,
                                {
                                    "id_manga": manga_id,
                                    "id_auteur": author_id_map[author],
                                },
                            )

                        # Gestion des thèmes
                        for theme in manga[6]:
                            if theme not in theme_id_map:
                                cursor.execute(
                                    """
                                    INSERT INTO theme (theme_name)
                                    VALUES (%s)
                                    RETURNING id_theme;
                                    """,
                                    (theme,),
                                )
                                res = cursor.fetchone()["id_theme"]
                                if res:
                                    theme_id_map[theme] = res

                            cursor.execute(
                                """
                                INSERT INTO association_manga_theme(id_manga, id_theme)
                                VALUES (%(id_manga)s, %(id_theme)s);
                                """,
                                {
                                    "id_manga": manga_id,
                                    "id_theme": theme_id_map[theme],
                                },
                            )

                        # Gestion des genres
                        for genre in manga[7]:
                            if genre not in genre_id_map:
                                cursor.execute(
                                    """
                                    INSERT INTO genre (genre_name)
                                    VALUES (%s)
                                    RETURNING id_genre;
                                    """,
                                    (genre,),
                                )
                                res = cursor.fetchone()["id_genre"]
                                if res:
                                    genre_id_map[genre] = res
                            cursor.execute(
                                """
                                INSERT INTO association_manga_genre(id_manga, id_genre)
                                VALUES (%(id_manga)s, %(id_genre)s);
                                """,
                                {
                                    "id_manga": manga_id,
                                    "id_genre": genre_id_map[genre],
                                },
                            )

                # Commit les modifications après l'insertion
                connection.commit()

        except Exception as e:
            logging.error(f"Erreur lors de l'insertion des mangas : {e}")
            raise

    @log
    def supprimer_toutes_les_donnees(self) -> bool:
        """Suppression de tous les mangas, thèmes, auteurs et genres dans la base de données

        Returns
        -------
        bool
            True si des données ont bien été supprimées, False sinon
        """

        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    # Supprimer toutes les associations d'abord (pour respecter les contraintes de clé étrangère)
                    cursor.execute("DELETE FROM association_manga_auteur")
                    cursor.execute("DELETE FROM association_manga_theme")
                    cursor.execute("DELETE FROM association_manga_genre")

                    # Supprimer tous les mangas
                    cursor.execute("DELETE FROM manga")
                    manga_count = cursor.rowcount  # Nombre de mangas supprimés

                    # Supprimer tous les thèmes
                    cursor.execute("DELETE FROM theme")
                    theme_count = cursor.rowcount  # Nombre de thèmes supprimés

                    # Supprimer tous les auteurs
                    cursor.execute("DELETE FROM auteur")
                    auteur_count = cursor.rowcount  # Nombre d'auteurs supprimés

                    # Supprimer tous les genres
                    cursor.execute("DELETE FROM genre")
                    genre_count = cursor.rowcount  # Nombre de genres supprimés

        except Exception as e:
            logging.info(f"Erreur lors de la suppression des données : {e}")
            raise

        # Vérifier si au moins une table a été modifiée
        total_supprime = manga_count + theme_count + auteur_count + genre_count
        return total_supprime > 0


test = MangaDao()
test.supprimer_toutes_les_donnees()
test.inserer_mangas("mangas.json")

                        LEFT JOIN association_manga_auteur using(id_manga)
                        LEFT JOIN auteur using(id_auteur)
                        LEFT JOIN association_manga_theme using(id_manga)
                        LEFT JOIN theme using(id_theme)
                        LEFT JOIN association_manga_genre using(id_manga)
                        LEFT JOIN genre using(id_genre)

import json
import logging
from utils.log_decorator import log
from utils.singleton import Singleton
from dao.db_connection import DBConnection
from business_object.manga import Manga


class MangaDao(metaclass=Singleton):
    """classe MangaDao"""

    def trouver_manga_par_id(self, id_manga) -> Manga:
        """Recherche et renvoie un manga par son id

        Parameters
        ---------
        id_manga: int
            numéro du manga qu'on veut rechercher

        Returns
        -------
        manga: Manga
            renvoie le manga
        """
        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "Select *",
                        "From manga",
                        "Where id_manga = %(id_manga)s ",
                        {"id_manga": id_manga},
                    )
                    res = cursor.fetchone()
        except Exception as e:
            logging.info(e)
            raise
        manga = None
        if res:
            manga = Manga(
                id_manga=res["id_manga"],
                titre=res["titre"],
                synopsis=res["synopsis"],
                auteur=res["auteur"],
                themes=res["themes"],
                genre=res["genre"],
            )
        return manga

    def trouver_manga_par_titre(self, titre):
        """Recherche et renvoie un manga par son titre

        Parameters
        ---------
        titre: str
            titre du manga qu'on veut rechercher

        Returns
        -------
        manga: Manga
            renvoie le manga
        """

        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "SELECT id_manga, titre, synopsis, genre_name as genre, name_auteur as auteur         "
                        "FROM manga join association_manga_genre using(id_manga) "
                        "join genre using(id_genre)                              "
                        "join association_manga_auteur using(id_manga)           "
                        "join auteur using(id_auteur)                            "
                        "WHERE titre = %(titre)s;                                ",
                        {"titre": titre},
                    )
                    res = cursor.fetchone()

            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "SELECT theme_name as theme                                      "
                        "FROM manga left join association_manga_theme using(id_manga)  "
                        "left join theme using(id_theme)                               "
                        "WHERE titre = %(titre)s;                                 ",
                        {"titre": titre},
                    )
                    res2 = cursor.fetchall()

        except Exception as e:
            logging.info(e)
            raise
        manga = None
        liste_themes = []

        if res2:
            for row in res2:
                liste_themes.append(row["theme"])

        delimiter = ', '
        liste_themes = delimiter.join(liste_themes)

        if res:
            manga = Manga(
                id_manga=res["id_manga"],
                titre=res.get("titre", "Titre inconnu"),  # res.get permet de donner une valeur par défaut si absent
                synopsis=res.get("synopsis") if res.get("synopsis") is not None else "Synopsis non disponible",  # Si val=null, ce serait mieux de gérer dans la BDD et mettre none
                auteur=res.get("auteur", "Auteur inconnu"),
                themes=liste_themes if liste_themes else ["Thèmes non disponibles"],
                genre=res.get("genre", "Genre non disponible")
            )
        return manga

    def rechercher_manga_par_titre(self, titre):
        """Recherche et renvoie un manga par son titre

        Parameters
        ---------
        titre: str
            titre du manga qu'on veut rechercher

        Returns
        -------
        liste_mangas : list[Manga]
           renvoie une liste de mangas correspondant au titre recherché
        """

        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    cursor.execute(
                        "SELECT id_manga, titre, synopsis "
                        "FROM manga "
                        "WHERE LOWER(titre) LIKE LOWER(%(titre)s);",
                        {"titre": f"%{titre}%"},
                    )
                    logging.info("Débogage : requête exécutée avec succès.")
                    res = cursor.fetchall()
                    # logging.info(f"Débogage : res récupéré avec la valeur : {res}")
                    liste_mangas = []

                    if res is not None:
                        for row in res:
                            manga = Manga(
                                id_manga=row["id_manga"],
                                titre=row["titre"],
                                synopsis=row["synopsis"],
                                auteur=None,
                                themes=None,
                                genre=None,
                            )
                            liste_mangas.append(manga)
                            #logging.info(f"Débogage : manga ajouté à liste_mangas, taille actuelle: {len(liste_mangas)}")

        except Exception as e:
            logging.info(e)
            raise

        return liste_mangas

    @log
    def inserer_mangas(self, fichier):
        """Insère les mangas, les auteurs, les genres et les themes dans la base de données"""
        with open(fichier, "r", encoding="utf-8") as f:
            mangas_data = json.load(f)
        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    # Réinitialiser les IDs
                    cursor.execute("TRUNCATE TABLE manga RESTART IDENTITY CASCADE;")
                    cursor.execute("TRUNCATE TABLE theme RESTART IDENTITY CASCADE;")
                    cursor.execute("TRUNCATE TABLE auteur RESTART IDENTITY CASCADE;")
                    cursor.execute("TRUNCATE TABLE genre RESTART IDENTITY CASCADE;")

                    # Dictionnaires pour vérfier les doublons des noms des thèmes/auteurs/genres
                    theme_id_map = {}
                    author_id_map = {}
                    genre_id_map = {}

                    # Insertion des mangas
                    for manga in mangas_data:
                        if not manga[0]:
                            continue
                        titre = manga[0]
                        volumes = manga[1]
                        publication = manga[3]["string"]
                        synopsis = manga[4]
                        cursor.execute(
                            "INSERT INTO manga(titre, volumes, publication, synopsis)"
                            "VALUES (%(titre)s, %(volumes)s, %(publication)s, %(synopsis)s)"
                            "RETURNING id_manga;",
                            {
                                "titre": titre,
                                "volumes": volumes,
                                "publication": publication,
                                "synopsis": synopsis,
                            },
                        )
                        manga_id = cursor.fetchone()["id_manga"]  # Récupérer l'id du manga inséré

                        # Gestion des auteurs
                        for author in manga[5]:
                            if author not in author_id_map:
                                cursor.execute(
                                    """
                                    INSERT INTO auteur (name_auteur)
                                    VALUES (%s)
                                    RETURNING id_auteur;
                                    """,
                                    (author,),
                                )
                                res = cursor.fetchone()["id_auteur"]
                                if res:
                                    author_id_map[author] = res

                            cursor.execute(
                                """
                                INSERT INTO association_manga_auteur(id_manga, id_auteur)
                                VALUES (%(id_manga)s, %(id_auteur)s);
                                """,
                                {
                                    "id_manga": manga_id,
                                    "id_auteur": author_id_map[author],
                                },
                            )

                        # Gestion des thèmes
                        for theme in manga[6]:
                            if theme not in theme_id_map:
                                cursor.execute(
                                    """
                                    INSERT INTO theme (theme_name)
                                    VALUES (%s)
                                    RETURNING id_theme;
                                    """,
                                    (theme,),
                                )
                                res = cursor.fetchone()["id_theme"]
                                if res:
                                    theme_id_map[theme] = res

                            cursor.execute(
                                """
                                INSERT INTO association_manga_theme(id_manga, id_theme)
                                VALUES (%(id_manga)s, %(id_theme)s);
                                """,
                                {
                                    "id_manga": manga_id,
                                    "id_theme": theme_id_map[theme],
                                },
                            )

                        # Gestion des genres
                        for genre in manga[7]:
                            if genre not in genre_id_map:
                                cursor.execute(
                                    """
                                    INSERT INTO genre (genre_name)
                                    VALUES (%s)
                                    RETURNING id_genre;
                                    """,
                                    (genre,),
                                )
                                res = cursor.fetchone()["id_genre"]
                                if res:
                                    genre_id_map[genre] = res
                            cursor.execute(
                                """
                                INSERT INTO association_manga_genre(id_manga, id_genre)
                                VALUES (%(id_manga)s, %(id_genre)s);
                                """,
                                {
                                    "id_manga": manga_id,
                                    "id_genre": genre_id_map[genre],
                                },
                            )

                # Commit les modifications après l'insertion
                connection.commit()

        except Exception as e:
            logging.error(f"Erreur lors de l'insertion des mangas : {e}")
            raise

    @log
    def supprimer_toutes_les_donnees(self) -> bool:
        """Suppression de tous les mangas, thèmes, auteurs et genres dans la base de données

        Returns
        -------
        bool
            True si des données ont bien été supprimées, False sinon
        """

        try:
            with DBConnection().connection as connection:
                with connection.cursor() as cursor:
                    # Supprimer toutes les associations d'abord (pour respecter les contraintes de clé étrangère)
                    cursor.execute("DELETE FROM association_manga_auteur")
                    cursor.execute("DELETE FROM association_manga_theme")
                    cursor.execute("DELETE FROM association_manga_genre")

                    # Supprimer tous les mangas
                    cursor.execute("DELETE FROM manga")
                    manga_count = cursor.rowcount  # Nombre de mangas supprimés

                    # Supprimer tous les thèmes
                    cursor.execute("DELETE FROM theme")
                    theme_count = cursor.rowcount  # Nombre de thèmes supprimés

                    # Supprimer tous les auteurs
                    cursor.execute("DELETE FROM auteur")
                    auteur_count = cursor.rowcount  # Nombre d'auteurs supprimés

                    # Supprimer tous les genres
                    cursor.execute("DELETE FROM genre")
                    genre_count = cursor.rowcount  # Nombre de genres supprimés

        except Exception as e:
            logging.info(f"Erreur lors de la suppression des données : {e}")
            raise

        # Vérifier si au moins une table a été modifiée
        total_supprime = manga_count + theme_count + auteur_count + genre_count
        return total_supprime > 0


#test = MangaDao()
#test.supprimer_toutes_les_donnees()
#test.inserer_mangas("mangas.json")

from InquirerPy import inquirer
import logging
from vues.vue_abstraite import VueAbstraite
from service.recherche_service import RechercheService
from dao.manga_dao import MangaDao


class RechercheMangaVue(VueAbstraite):
    def choisir_menu(self):
        """Choix du menu suivant de l'utilisateur

        Return
        ------
        vue
            Retourne la vue choisie par l'utilisateur dans le terminal
        """

        print("\n" + "-" * 50 + "\nRecherche d'un manga\n" + "-" * 50 + "\n")

        choix = inquirer.select(
            message="Faites votre choix : ",
            choices=["Entrer le titre du manga recherché", "Retour au menu précédent"],
        ).execute()

        match choix:
            case "Entrer le titre du manga recherché":
                titre = inquirer.text(message="Entrer le titre : ").execute()
                choix2 = RechercheService().recherche_manga_par_t(titre)
                choix2.append("Retour au menu précédent")
                if choix2:
                    choix3 = inquirer.select(
                                            message="Choisissez un manga : ",
                                            choices=choix2,
                                            ).execute()
                    if choix3 == "Retour au menu précédent":
                        from vues.menu_utilisateur_vue import MenuUtilisateurVue
                        return MenuUtilisateurVue()
                    logging.info(f"Débogage : manga récupéré avec la valeur : {choix3}")
                    manga = MangaDao().trouver_manga_par_titre(choix3)
                    choix4 = inquirer.select(
                                            message="Faites votre choix : ",
                                            choices=["Ajouter à une collection", "Afficher les informations du manga", "Consulter les avis", "Ajouter un avis", "Retour au menu précédent", "Retour vers l'écran d'accueil"],
                                            ).execute()
                    match choix4:
                        case "Ajouter à une collection":
                            pass
                        case "Afficher les informations du manga":
                            print("\n" + "-" * 50 + "\nInformations du manga\n" + "-" * 50 + "\n")
                            print("Titre : " + str(manga.titre) + "\n" + "-" * 50)
                            print("Synopsis : " + str(manga.synopsis) + "\n" + "-" * 50)
                            print("Auteur : " + str(manga.auteur) + "\n" + "-" * 50)
                            print("Thèmes : " + str(manga.themes) + "\n" + "-" * 50)
                            print("Genre : " + str(manga.genre) + "\n" + "-" * 50)
                            choix5 = inquirer.select(
                                                    message="Faites votre choix : ",
                                                    choices=["Retour au menu précédent"],
                                                    ).execute()
                            if choix5:
                                from vues.recherche_vue import RechercheVue
                                return RechercheVue()
                        case "Consulter les avis":
                            pass
                        case "Ajouter un avis":
                            pass
                        case "Retour au menu précédent":
                            from vues.recherche_vue import RechercheVue

                            return RechercheVue()
                        case "Retour vers l'écran d'accueil":
                            from vues.menu_utilisateur_vue import MenuUtilisateurVue

                            return MenuUtilisateurVue()
                from vues.menu_utilisateur_vue import MenuUtilisateurVue

                return MenuUtilisateurVue()

from dao.utilisateur_dao import UtilisateurDao
from business_object.manga import Manga
from dao.manga_dao import MangaDao
from business_object.utilisateur import Utilisateur


class RechercheService:
    """Classe"""

    def recherche_manga_par_t(self, titre: str) -> Manga:
        """Recherche un manga par son titre
        Parameters
        ----------
        titre : str

        Returns
        -------
        manga : Manga
            renvoie le manga recherché"""
        res = MangaDao().rechercher_manga_par_titre(titre)
        if res:
            return [j.titre for j in res]
        return f"Aucun manga trouvé pour le titre '{titre}'."

    def recherche_utilisateur(self, pseudo):
        """Recherche un utilisateur par son pseudo
        Parameters
        ----------
        pseudo : str

        Returns
        -------
        utilisateur : Utilisateur
            renvoie l'utilisateur recherché
        """
        res = UtilisateurDao().rechercher_tous_pseudo(pseudo)
        if res:
            return [j.pseudo for j in res]
        return print(f"Aucun utilisateur trouvé pour le pseudo '{pseudo}'.")